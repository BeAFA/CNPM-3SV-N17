{% extends 'layout/base.html' %}

{% block title %}Admin Dashboard{% endblock %}

{% block header %}
{% include 'layout/header.html' %}
<!-- Liên kết CSS riêng cho Admin -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
<script src="{{ url_for('static', filename='js/bar_chart.js') }}"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">Admin Dashboard</h2>

    <!-- Tổng số nhân sự -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">Bác sĩ</h5>
                    <p class="card-text display-4">{{ stats.total_doctors }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">Bệnh nhân</h5>
                    <p class="card-text display-4">{{ stats.total_patients }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">Kế toán</h5>
                    <p class="card-text display-4">{{ stats.total_accountants }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Lịch hẹn -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card text-center bg-light">
                <div class="card-body">
                    <h5 class="card-title">Lịch hẹn hôm nay</h5>
                    <p class="card-text display-4">{{ stats.appointments_today }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center bg-light">
                <div class="card-body">
                    <h5 class="card-title">Lịch hẹn tuần</h5>
                    <p class="card-text display-4">{{ stats.appointments_week }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center bg-light">
                <div class="card-body">
                    <h5 class="card-title">Lịch hẹn tháng</h5>
                    <p class="card-text display-4">{{ stats.appointments_month }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Hóa đơn và doanh thu -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card text-center bg-success text-white">
                <div class="card-body">
                    <h5 class="card-title">Hóa đơn hôm nay</h5>
                    <p class="card-text display-4">{{ stats.bills_today }}</p>
                    <small>Doanh thu: {{ stats.revenue_today }} VNĐ</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center bg-success text-white">
                <div class="card-body">
                    <h5 class="card-title">Hóa đơn tuần</h5>
                    <p class="card-text display-4">{{ stats.bills_week }}</p>
                    <small>Doanh thu: {{ stats.revenue_week }} VNĐ</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center bg-success text-white">
                <div class="card-body">
                    <h5 class="card-title">Hóa đơn tháng</h5>
                    <p class="card-text display-4">{{ stats.bills_month }}</p>
                    <small>Doanh thu: {{ stats.revenue_month }} VNĐ</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Bọc toàn bộ phần thống kê dịch vụ và thuốc vào khung trắng -->
    <div class="stats-box p-4 mb-4">

        <!-- Dịch vụ phổ biến -->
        <h4 class="mt-4">Dịch vụ phổ biến</h4>
        <table class="table table-striped">
            <thead>
            <tr>
                <th>Tên dịch vụ</th>
                <th>Số lần sử dụng</th>
            </tr>
            </thead>
            <tbody>
            {% for svc, count in stats.popular_services %}
            <tr>
                <td>{{ svc }}</td>
                <td>{{ count }}</td>
            </tr>
            {% endfor %}
            </tbody>
        </table>

        <!-- Thuốc bán chạy -->
        <h4 class="mt-4">Thuốc bán chạy</h4>
        <table class="table table-striped">
            <thead>
            <tr>
                <th>Tên thuốc</th>
                <th>Số lượng đã bán</th>
            </tr>
            </thead>
            <tbody>
            {% for med, sold in stats.top_medicines %}
            <tr>
                <td>{{ med }}</td>
                <td>{{ sold }}</td>
            </tr>
            {% endfor %}
            </tbody>
        </table>

        <!-- Thuốc tồn kho thấp -->
        <h4 class="mt-4 text-danger">Thuốc tồn kho thấp (≤10)</h4>
        <table class="table table-striped">
            <thead>
            <tr>
                <th>Tên thuốc</th>
                <th>Số lượng tồn</th>
            </tr>
            </thead>
            <tbody>
            {% for lot in stats.low_stock_medicines %}
            <tr>
                <td>{{ lot.loai_thuoc.TenThuoc }}</td>
                <td>{{ lot.SoLuongTon }}</td>
            </tr>
            {% endfor %}
            </tbody>
        </table>

    </div>
</div>

<div class="card mb-4 shadow-sm">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <h5 class="m-0 font-weight-bold text-primary">Biểu đồ doanh thu</h5>
        <select id="chartFilter" class="form-control w-25" onchange="loadChartData()">
            <option value="month">Theo Tháng (Năm nay)</option>
            <option value="doctor">Theo Bác sĩ</option>
        </select>
    </div>
    <div class="card-body">
        <div style="height: 80vh;">
            <canvas id="revenueChart"></canvas>
        </div>
    </div>
</div>
{% endblock %}
